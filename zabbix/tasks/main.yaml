---
- name: Add zabbix China mirrors
  yum_repository:
      name: Zabbix
      description: Zabbix version
      baseurl: https://mirrors.aliyun.com/zabbix/zabbix/4.4/rhel/7/$basearch/
      gpgkey: https://mirrors.aliyun.com/zabbix/RPM-GPG-KEY-ZABBIX
      gpgcheck: no

- name: Add mariadb-10.4 repo file
  yum_repository:
      name: mariadb104
      description: 10.4 version of mariadb
      baseurl: https://mirrors.aliyun.com/mariadb/yum/10.4/centos7-amd64/
      gpgkey: https://mirrors.aliyun.com/mariadb/yum/RPM-GPG-KEY-MariaDB
      gpgcheck: yes

- name: Add CentOS mirror
  get_url:
    url: http://mirrors.aliyun.com/repo/Centos-7.repo
    dest: /etc/yum.repos.d/CentOS-7.repo

- name: Install MariaDB-10.4
  yum:
    update_cache: yes
    pkg:
      - MariaDB-client
      - MariaDB-server

- name: Install pip from epel
  yum:
    pkg:
      python-pip


- name: Install PyMySQL module
  command: 'pip install -i {{ pip_mirror }} pymysql'


- name: Install zabbix-{{zbx_version}}
  yum:
    pkg:
      - zabbix-server-mysql-{{zbx_version}}
      - zabbix-web-mysql-{{zbx_version}}

- name: Start mariadb services and enabled then
  service:
    name: mariadb
    state: restarted
    enabled: yes

- name: Create zabbix database
  mysql_db:
      name: zabbix
      login_user: '{{ mysql_super }}'
      login_port: '{{ mysql_port }}'
      login_password: '{{ mysql_super_pass }}'
      login_host: '{{ mysql_host }}'
      login_unix_socket: '{{ mysql_socket }}'
      encoding: 'utf8'
      state: present

- name: Create zabbix user
  mysql_user:
    login_user: '{{ mysql_super }}'
    login_password: '{{ mysql_super_pass }}'
    login_host: '{{ mysql_host }}'
    login_port: '{{ mysql_port }}'
    name: '{{ mysql_zbx_user }}'
    host: localhost
    priv: '*.*:ALL'
    password: '{{ mysql_zbx_pass }}'
    login_unix_socket: '{{ mysql_socket }}'
    state: present
  no_log: True

- name: Import zabbix schema
  mysql_db:
      name: zabbix
      login_host: '{{ mysql_host }}'
      login_user: '{{ mysql_super }}'
      login_port: '{{ mysql_port }}'
      login_password: '{{ mysql_super_pass }}'
      login_unix_socket: '{{ mysql_socket }}'
      target: "/usr/share/doc/zabbix-server-mysql-{{ zbx_version }}/create.sql.gz"
      state: "import"

- name: Init zabbix server config
  template:
    src: zabbix_server.conf.j2
    dest: /etc/zabbix/zabbix_server.conf
  notify:
    - restart zabbix-server

- name: Init zabbix web config
  replace:
    path: '/etc/httpd/conf.d/zabbix.conf'
    regexp: '# php_value date.timezone Europe\/Riga'
    replace: 'php_value date.timezone Asia/Shanghai'
  notify:
    - restart httpd

