---
- name: Start install docker
  include_role:
    name: dockerce

- name: Install k8s component
  yum:
    pkg:
      - kubelet
      - kubectl
      - kubeadm
    state: installed
  notify:
    - enable kubelet

- name: Create kubectl directory
  file:
    path: "~/.kube"
    state: directory

- name: Init k8s
  template:
    src: kube-admin-init.yaml.j2
    dest: /etc/kubernetes/kube-admin-init.yaml


- name: Init calico
  get_url:
    url: https://docs.projectcalico.org/manifests/calico.yaml
    dest: /tmp/calico.yaml

- name: Replace calico IP
  replace:
    path: "/tmp/calico.yaml"
    regexp: '{{ item.name }}'
    replace: '{{ item.line }}'
  with_items:
    - {name: '# - name: CALICO_IPV4POOL_CIDR', line: '- name: CALICO_IPV4POOL_CIDR'}
    - {name: '#   value: "192.168.0.0/16"', line: '  value: "{{ pod_ip_range }}"'}
    - {name: 'value: "Always"', line: 'value: "{{ calico_ipv4pool_ipip }}"'}
  run_once: true

- name: Install calico
  shell: "kubectl apply -f /tmp/calico.yaml"
  run_once: true
